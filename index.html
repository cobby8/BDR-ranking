<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BDR 랭킹 - 일반부</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (엑셀 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <meta name="color-scheme" content="dark" />
  <style>
    .surface { background: #0e141c; }
    .card { background: #131a24; }
    .muted { color: #94a3b8; }
    .accent { color: #ffd54a; }
    .shadow-smooth { box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .num { font-variant-numeric: tabular-nums; }

    /* Movement badge */
    .badge { display:inline-flex; align-items:center; gap:.4rem; border-radius:9999px; padding:.35rem .75rem; line-height:1; font-weight:800; font-size:.95rem; }
    .badge-up   { background: rgba(239, 68, 68, 0.15); color:#fecaca; border:1px solid rgba(239,68,68,.35);}
    .badge-down { background: rgba(59,130,246, 0.15); color:#bfdbfe; border:1px solid rgba(59,130,246,.35);}
    .badge-stay { background: rgba(148,163,184,0.12); color:#cbd5e1; border:1px solid rgba(148,163,184,.30);}
    .icon { width: 1.05em; height: 1.05em; }

    /* Top-3 decoration */
    .top1 { border:1.5px solid rgba(255,215,0,.55); background: linear-gradient(180deg, rgba(255,215,0,0.10), transparent 50%) , #131a24; }
    .top2 { border:1.5px solid rgba(192,192,192,.55); background: linear-gradient(180deg, rgba(192,192,192,0.10), transparent 50%) , #131a24; }
    .top3 { border:1.5px solid rgba(205,127,50,.55); background: linear-gradient(180deg, rgba(205,127,50,0.10), transparent 50%) , #131a24; }
    .medal { font-weight:900; letter-spacing:.02em; }
    .medal-g { color:#ffd700; }
    .medal-s { color:#c0c0c0; }
    .medal-b { color:#cd7f32; }

    /* Movement animations */
    @keyframes popUp {
      0%   { transform: translateY(4px) scale(.98); opacity:.0; }
      60%  { transform: translateY(-2px) scale(1.02); opacity:1; }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes popDown {
      0%   { transform: translateY(-4px) scale(.98); opacity:.0; }
      60%  { transform: translateY(2px) scale(1.02); opacity:1; }
      100% { transform: translateY(0) scale(1); }
    }
    .animate-up   { animation: popUp .45s cubic-bezier(.2,.8,.2,1); }
    .animate-down { animation: popDown .45s cubic-bezier(.2,.8,.2,1); }

    /* Loader */
    .spinner {
      width: 24px; height: 24px; border-radius: 9999px;
      border: 3px solid #1f2a3a; border-top-color: #60a5fa;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body class="min-h-screen surface text-white antialiased">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col items-center justify-center mb-6">
      <!-- 로고: 필요 시 src 교체 -->
      <img src="BDR(배경없음).png" alt="BDR Logo" class="h-20 object-contain mb-2">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">BDR 랭킹 - 일반부</h1>
      <div class="text-xs muted mt-1" id="lastUpdated"></div>
    </div>

    <!-- Filters in header -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
      <input id="search" type="search" placeholder="팀명/지역 검색…" class="col-span-2 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" />
      <select id="region" class="rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3">
        <option value="">전체 지역</option>
      </select>
    </div>

    <!-- Loading / Error -->
    <div id="status" class="flex items-center gap-3 text-sm muted mb-3">
      <div class="spinner" aria-hidden="true"></div>
      <span>데이터 불러오는 중…</span>
    </div>
    <div id="error" class="hidden text-sm text-red-400 mb-3"></div>

    <!-- List -->
    <div id="list" class="space-y-2"></div>

    <!-- Pager -->
    <div class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="rounded-full px-3 py-1 bg-[#0c1220] border border-[#1f2a3a] text-xs">페이지 <span id="pageNow">1</span> / <span id="pageTotal">1</span></div>
      <div class="muted text-sm">총 <span id="rowCount"></span>개 팀</div>
      <div class="flex gap-2">
        <button id="prev" class="px-4 py-2 rounded-lg bg-[#0b111a] border border-[#1f2a3a] disabled:opacity-50">이전</button>
        <button id="next" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">다음</button>
      </div>
    </div>
  </div>

  <script>
    // ========= 1) GitHub RAW XLSX 경로만 바꾸면 동작 =========
    // 예) https://raw.githubusercontent.com/<owner>/<repo>/<branch>/팀랭킹_20250813_1.xlsx
    const GITHUB_XLSX_URL = "https://github.com/cobby8/BDR-ranking/blob/883ea4be400a406e416e8c8e3cd8ff50347ce1b1/%ED%8C%80%EB%9E%AD%ED%82%B9_20250813_1.xlsx";

    // ========= 2) 컬럼 자동 매핑 후보 (시트 헤더 기준) =========
    const MAP_CANDIDATES = {
      rank:  ["랭킹","순위","rank"],
      team:  ["팀","팀명","name","team","클럽"],
      city:  ["지역","연고","도시","city","location"],
      score: ["점수","score","포인트","point"],
      move:  ["랭킹 변화","증감","변동","delta","updown","전주대비","전월대비"]
    };

    // ========= 내부 상태 =========
    let BASE = [];   // 표준화된 데이터
    let FILTERED = [];
    let PAGE = 1;
    const PAGE_SIZE = 20;

    // ========= 요소 참조 =========
    const list = document.getElementById('list');
    const search = document.getElementById('search');
    const region = document.getElementById('region');
    const pageNow = document.getElementById('pageNow');
    const pageTotal = document.getElementById('pageTotal');
    const rowCount = document.getElementById('rowCount');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');

    // ========= 유틸 =========
    function formatDate(d) {
      const z = (n)=> String(n).padStart(2,'0');
      return `${d.getFullYear()}년 ${z(d.getMonth()+1)}월 ${z(d.getDate())}일`;
    }
    document.getElementById('lastUpdated').textContent = formatDate(new Date());

    function pickColumn(headerKeys, candidates) {
      for (const cand of candidates) {
        const found = headerKeys.find(k => (k || "").toString().toLowerCase().includes(cand.toLowerCase()));
        if (found) return found;
      }
      return null;
    }

    function byRankClass(rank) {
      if (rank === 1) return 'top1';
      if (rank === 2) return 'top2';
      if (rank === 3) return 'top3';
      return '';
    }
    function medalSpan(rank) {
      if (rank === 1) return '<span class="medal medal-g">GOLD</span>';
      if (rank === 2) return '<span class="medal medal-s">SILVER</span>';
      if (rank === 3) return '<span class="medal medal-b">BRONZE</span>';
      return '';
    }

    function movementBadge(move) {
      const n = Number(move);
      if (Number.isNaN(n)) return `<span class="badge badge-stay" title="지난 주 대비 정보 없음">${move ?? "—"}</span>`;
      if (n > 0) {
        return `<span class="badge badge-up animate-up" title="지난 주 대비 +${n}">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M7 17a1 1 0 0 1-.707-1.707l9-9H10a1 1 0 1 1 0-2h9a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-5.293l-9 9A.997.997 0 0 1 7 17z"/>
          </svg>
          +${n}
        </span>`;
      }
      if (n < 0) {
        const v = Math.abs(n);
        return `<span class="badge badge-down animate-down" title="지난 주 대비 -${v}">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M17 7a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1h-9a1 1 0 1 1 0-2h5.293l-9-9A1 1 0 1 1 5.707 6.293l9 9V10a1 1 0 0 1 2 0V7z"/>
          </svg>
          -${v}
        </span>`;
      }
      return `<span class="badge badge-stay" title="지난 주 대비 0">— 0</span>`;
    }

    function applyFilter() {
      const q = (search.value || '').toLowerCase();
      const reg = region.value;
      FILTERED = BASE.filter(item => {
        const hay = (item.team + ' ' + item.city).toLowerCase();
        const okQ = !q || hay.includes(q);
        const okR = !reg || item.city === reg;
        return okQ && okR;
      });
      PAGE = 1;
      render();
    }

    function render() {
      const totalPages = Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE));
      if (PAGE > totalPages) PAGE = totalPages;
      pageNow.textContent = PAGE;
      pageTotal.textContent = totalPages;
      rowCount.textContent = FILTERED.length;

      const start = (PAGE - 1) * PAGE_SIZE;
      const slice = FILTERED.slice(start, start + PAGE_SIZE);

      list.innerHTML = slice.map(item => `
        <div class="card shadow-smooth rounded-2xl border border-[#1f2a3a] px-4 sm:px-6 py-4 ${byRankClass(item.rank)}">
          <div class="grid grid-cols-12 items-center gap-3">
            <div class="col-span-2 sm:col-span-1 flex flex-col items-start">
              <div class="text-2xl sm:text-3xl font-extrabold num">${item.rank}</div>
              <div class="text-[10px] mt-1">${medalSpan(item.rank)}</div>
            </div>
            <div class="col-span-3 sm:col-span-2">
              ${movementBadge(item.move)}
            </div>
            <div class="col-span-4 sm:col-span-6">
              <div class="text-lg sm:text-xl font-semibold">${item.team}</div>
              <div class="text-xs muted mt-0.5">${item.city || ''}</div>
            </div>
            <div class="col-span-3 sm:col-span-3 text-right">
              <div class="text-2xl sm:text-3xl font-extrabold accent num">${(item.score ?? '').toString()}</div>
              <div class="text-[10px] muted">점</div>
            </div>
          </div>
        </div>
      `).join('');

      document.getElementById('prev').disabled = PAGE <= 1;
      document.getElementById('next').disabled = PAGE >= totalPages;
    }

    // 이벤트
    search.addEventListener('input', applyFilter);
    region.addEventListener('change', applyFilter);
    document.getElementById('prev').addEventListener('click', () => { PAGE = Math.max(1, PAGE - 1); render(); });
    document.getElementById('next').addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE));
      PAGE = Math.min(totalPages, PAGE + 1);
      render();
    });

    // ========= 3) GitHub에서 엑셀 불러와 파싱 =========
    async function loadFromGithub() {
      try {
        const res = await fetch(GITHUB_XLSX_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(new Uint8Array(ab), { type: "array" });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        // 헤더 키 파악
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: true });
        const headerKeys = Object.keys(rows[0] || {});
        // 컬럼 선택
        const cRank  = pickColumn(headerKeys, MAP_CANDIDATES.rank);
        const cTeam  = pickColumn(headerKeys, MAP_CANDIDATES.team);
        const cCity  = pickColumn(headerKeys, MAP_CANDIDATES.city);
        const cScore = pickColumn(headerKeys, MAP_CANDIDATES.score);
        const cMove  = pickColumn(headerKeys, MAP_CANDIDATES.move);

        // 지역 옵션 구성
        const regionSet = new Set();
        BASE = rows.map((r, i) => {
          const obj = {
            rank:  cRank  ? Number(r[cRank])  || (i+1) : (i+1),
            team:  cTeam  ? r[cTeam]  : "",
            city:  cCity  ? r[cCity]  : "",
            score: cScore ? r[cScore] : "",
            move:  cMove  ? (r[cMove] === "" ? 0 : r[cMove]) : 0,
            raw:   r
          };
          if (obj.city) regionSet.add(obj.city);
          return obj;
        });

        // 지역 드롭다운 채우기
        region.innerHTML = '<option value="">전체 지역</option>' + Array.from(regionSet).sort().map(v => `<option value="${v}">${v}</option>`).join('');

        statusEl.classList.add('hidden');
        FILTERED = [...BASE];
        render();
      } catch (err) {
        statusEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        errorEl.textContent = `데이터 로드 오류: ${err.message}. GitHub "Raw" 링크(Git LFS 아님)와 파일 공개 여부를 확인하세요.`;
      }
    }

    // 시작!
    loadFromGithub();

  </script>
</body>
</html>
