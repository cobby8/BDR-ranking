<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BDR 랭킹 - 일반부</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<meta name="color-scheme" content="dark" />
<style>
  :root{--surface:#0e141c;--card:#131a24;--muted:#94a3b8;--accent:#ffd54a}
  html,body{background:var(--surface)}
  .surface{background:var(--surface)} .card{background:var(--card)} .muted{color:var(--muted)} .accent{color:var(--accent)}
  .shadow-smooth{box-shadow:0 10px 30px rgba(0,0,0,.35)} .num{font-variant-numeric:tabular-nums}

  /* ── 가독성 업그레이드 ───────────────────────────────── */
  body{font-size:17px; line-height:1.55}
  .card{border:1px solid #1f2a3a}
  .card .grid{row-gap:0.5rem}
  .city-line{font-size:1.125rem} /* +~30% */
  .title{letter-spacing:.2px}

  /* Movement badge */
  .badge{display:inline-flex;align-items:center;gap:.45rem;border-radius:9999px;padding:.4rem .8rem;line-height:1;font-weight:800;font-size:1rem}
  .badge-up{background:rgba(239,68,68,.18);color:#fca5a5;border:1px solid rgba(239,68,68,.5)}
  .badge-down{background:rgba(59,130,246,.18);color:#93c5fd;border:1px solid rgba(59,130,246,.5)}
  .badge-stay{background:rgba(148,163,184,.14);color:#cbd5e1;border:1px solid rgba(148,163,184,.34)}
  .icon{width:1.1em;height:1.1em}

  /* Score change styles */
  .score-up { color: #f87171; font-weight: 700; }
  .score-down { color: #60a5fa; font-weight: 700; }
  .score-same { color: #94a3b8; font-weight: 600; }

  /* Top-3 decoration */
  .top1{border:1.5px solid rgba(255,215,0,.55);background:linear-gradient(180deg,rgba(255,215,0,.10),transparent 50%),var(--card)}
  .top2{border:1.5px solid rgba(192,192,192,.55);background:linear-gradient(180deg,rgba(192,192,192,.10),transparent 50%),var(--card)}
  .top3{border:1.5px solid rgba(205,127,50,.55);background:linear-gradient(180deg,rgba(205,127,50,.10),transparent 50%),var(--card)}
  .medal{font-weight:900;letter-spacing:.02em}.medal-g{color:#ffd700}.medal-s{color:#c0c0c0}.medal-b{color:#cd7f32}

  /* Movement animations */
  @keyframes popUp{0%{transform:translateY(4px) scale(.98);opacity:0}60%{transform:translateY(-2px) scale(1.02);opacity:1}100%{transform:translateY(0) scale(1)}}
  @keyframes popDown{0%{transform:translateY(-4px) scale(.98);opacity:0}60%{transform:translateY(2px) scale(1.02);opacity:1}100%{transform:translateY(0) scale(1)}}
  .animate-up{animation:popUp .45s cubic-bezier(.2,.8,.2,1)}.animate-down{animation:popDown .45s cubic-bezier(.2,.8,.2,1)}

  /* Region rank chip */
  .chip{font-size:.85rem;padding:.4rem .7rem;border-radius:9999px;background:#0c1220;border:1px solid #1f2a3a}
  .chip-region{background:rgba(99,102,241,.14);border-color:rgba(99,102,241,.45);color:#c7d2fe}

  /* ── 4:5 캡처 전용 ─────────────────────────────── */
  .exporting { font-size:18px; }
  .exporting .title{font-size:2rem}
  .exporting .rank-num{font-size:2.2rem}
  .exporting .team-name{font-size:1.6rem}
  .exporting .score-val{font-size:2.2rem}
  .exporting .badge{font-size:1.05rem}
</style>
</head>
<body class="min-h-screen surface text-white antialiased">
<div class="max-w-6xl mx-auto px-4 py-6">
  <!-- 화면 표시용(검색/필터/안내 포함) -->
  <div id="screenRoot" class="space-y-4">
    <!-- 헤더: 로고/제목 중앙, 날짜는 제목 오른쪽(하단 정렬) -->
    <div class="flex flex-col items-center w-full">
      <img src="BDR(배경없음).png" alt="BDR Logo" class="h-20 object-contain mb-2" crossOrigin="anonymous">
      <div class="flex items-end justify-between w-full">
        <h1 class="title text-3xl sm:text-4xl font-bold">BDR 랭킹 - 일반부</h1>
        <span id="lastUpdated" class="text-lg font-semibold muted"></span>
      </div>
    </div>

    <!-- 컨트롤 바 (화면 전용) -->
    <div class="grid grid-cols-1 sm:grid-cols-5 gap-3">
      <input id="search" type="search" placeholder="팀명/지역 검색…" class="sm:col-span-2 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" />
      <select id="region" class="sm:col-span-1 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3">
        <option value="">전체 지역</option>
      </select>

      <!-- 내보내기 범위 선택 & 버튼 (화면에서만 보임, 캡처엔 제외) -->
      <select id="exportRange" class="sm:col-span-1 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3">
        <option value="1-15">1–15위</option>
      </select>
      <button id="btnExport" class="sm:col-span-1 rounded-xl bg-[#0b111a] border border-[#1f2a3a] px-4 py-3 hover:bg-[#131a24]">
        4:5 이미지 다운로드
      </button>
    </div>

    <!-- 안내 문구 (화면 전용) -->
    <p class="text-sm text-indigo-200/80 text-right -mt-1">
      ※ 지역필터를 적용하면 지역별 랭킹을 보실 수 있습니다.
    </p>

    <!-- 리스트(화면 표시용) -->
    <div id="list" class="space-y-3"></div>

    <div class="flex items-center justify-end">
      <div class="muted text-sm">총 <span id="rowCount"></span>개 팀</div>
    </div>
  </div>

  <!-- 상태/오류 -->
  <div id="status" class="flex items-center gap-3 text-sm muted mt-3">
    <div class="spinner" aria-hidden="true" style="width:22px;height:22px;border-radius:9999px;border:3px solid #1f2a3a;border-top-color:#60a5fa;animation:spin .9s linear infinite"></div>
    <span>데이터 불러오는 중…</span>
  </div>
  <div id="error" class="hidden text-sm text-red-400 mt-2"></div>
</div>

<script>
  /* ========== 설정 ========== */
  const LOCAL_XLSX_URL = "./%ED%8C%80%EB%9E%AD%ED%82%B9_20250813_1.xlsx";

  /* ========== 상태 ========== */
  let BASE=[], FILTERED=[], LOCAL_RANK_MAP=null;
  const list=document.getElementById('list'), search=document.getElementById('search'), region=document.getElementById('region');
  const rowCount=document.getElementById('rowCount'), statusEl=document.getElementById('status'), errorEl=document.getElementById('error');
  const lastUpdated=document.getElementById('lastUpdated');
  const exportRangeEl=document.getElementById('exportRange');

  /* ========== 유틸 ========== */
  function formatDate(d){const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}년 ${z(d.getMonth()+1)}월 ${z(d.getDate())}일`;}
  lastUpdated.textContent=formatDate(new Date());

  const MAP_CANDIDATES={
    rank:["랭킹","순위","rank"],
    team:["팀","팀명","name","team","클럽"],
    city:["지역","연고","도시","city","location"],
    score:["점수","score","포인트","point"],
    move:["랭킹 변화","증감","변동","delta","updown","전주대비","전월대비"],
    scoreChange:["점수 변화","점수 증감","score change","score diff","score_delta"]
  };
  function pickColumn(keys,cands){for(const c of cands){const f=keys.find(k=>(k||"").toLowerCase().includes(c.toLowerCase())); if(f) return f} return null}
  function byRankClass(r){return r===1?'top1':r===2?'top2':r===3?'top3':''}
  function medalSpan(r){return r===1?'<span class="medal medal-g">GOLD</span>':r===2?'<span class="medal medal-s">SILVER</span>':r===3?'<span class="medal medal-b">BRONZE</span>':''}

  function movementBadge(m){
    const n=Number(m);
    if(Number.isNaN(n)) return `<span class="badge badge-stay" title="지난 주 대비 0">— 0</span>`;
    if(n>0) return `<span class="badge badge-up animate-up" title="지난 주 대비 +${n}">+${n}</span>`;
    if(n<0) return `<span class="badge badge-down animate-down" title="지난 주 대비 -${Math.abs(n)}">-${Math.abs(n)}</span>`;
    return `<span class="badge badge-stay" title="지난 주 대비 0">— 0</span>`;
  }
  function scoreChangeBadge(val){
    if(val===null || val===undefined || val==="" || Number(val)===0) return `<span class="score-same">-</span>`;
    const num=Number(val);
    if(Number.isNaN(num)) return `<span class="score-same">-</span>`;
    if(num>0) return `<span class="score-up">+${num}</span>`;
    if(num<0) return `<span class="score-down">-${Math.abs(num)}</span>`;
    return `<span class="score-same">-</span>`;
  }

  /* ========== 지역 랭킹 ========== */
  function buildLocalRankMap(){
    const reg=region.value;
    if(!reg){ LOCAL_RANK_MAP=null; return; }
    const subset = FILTERED.slice().sort((a,b)=> (a.rank??Infinity)-(b.rank??Infinity));
    const map = new Map();
    subset.forEach((item, idx) => {
      const key = item.team + "||" + (item.city || "");
      map.set(key, idx+1);
    });
    LOCAL_RANK_MAP = map;
  }
  function regionalBadge(team, city){
    if(!LOCAL_RANK_MAP) return '';
    const key = team + "||" + (city || "");
    const n = LOCAL_RANK_MAP.get(key);
    if(!n) return '';
    return `<span class="chip chip-region" title="현재 선택한 지역 내 순위">지역 랭킹 ${n}위</span>`;
  }

  /* ========== 카드 HTML ========== */
  function cardHTML(it){
    const scoreVal = Number(it.score);
    const scoreText = isNaN(scoreVal) ? (it.score??'') : scoreVal.toFixed(1); // 점수: 소수점 1자리
    return `
    <div class="card shadow-smooth rounded-2xl px-5 sm:px-7 py-5 ${byRankClass(it.rank)}">
      <div class="grid grid-cols-12 items-center gap-4">
        <!-- 순위 -->
        <div class="col-span-2 sm:col-span-1 flex flex-col items-start">
          <div class="rank-num text-3xl sm:text-4xl font-extrabold num">${it.rank}</div>
          <div class="text-[11px] mt-1">${medalSpan(it.rank)}</div>
        </div>

        <!-- 랭킹변화/지역랭킹 -->
        <div class="col-span-3 sm:col-span-3 flex flex-col items-start gap-1.5">
          ${movementBadge(it.move)}
          ${regionalBadge(it.team, it.city)}
        </div>

        <!-- 팀/지역 -->
        <div class="col-span-4 sm:col-span-5">
          <div class="team-name text-2xl font-semibold">${it.team}</div>
          <div class="city-line muted mt-0.5">${it.city || ''}</div>
        </div>

        <!-- 점수 / 점수변화 -->
        <div class="col-span-3 sm:col-span-3 text-right">
          <div class="score-val text-3xl sm:text-4xl font-extrabold accent num">${scoreText}</div>
          <div class="mt-1.5 flex justify-end items-baseline gap-1.5">
            <span class="text-xl">${scoreChangeBadge(it.scoreChange)}</span>
            <span class="text-xl muted">점</span>
          </div>
        </div>
      </div>
    </div>`;
  }

  /* ========== 화면 렌더 ========== */
  function applyFilter(){
    const q=(search.value||'').toLowerCase(), reg=region.value;
    FILTERED=BASE.filter(it=>{
      const hay=(it.team+' '+it.city).toLowerCase();
      return (!q||hay.includes(q))&&(!reg||it.city===reg);
    });
    buildLocalRankMap();
    renderScreen();
    buildExportRanges(); // 팀 수 변동 시 내보내기 범위 갱신
  }

  function renderScreen(){
    rowCount.textContent = FILTERED.length;
    list.innerHTML = FILTERED.map(cardHTML).join('');
  }

  /* ========== 내보내기 범위 구성(15팀 단위) ========== */
  function buildExportRanges(){
    const total = FILTERED.length;
    const pageSize = 15;
    const pages = Math.ceil(total / pageSize) || 1;
    const opts = [];
    for(let i=0;i<pages;i++){
      const start = i*pageSize + 1;
      const end = Math.min((i+1)*pageSize, total);
      opts.push({label:`${start}–${end}위`, value:`${start}-${end}`});
    }
    exportRangeEl.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
  }

  /* ========== 데이터 로드 ========== */
  async function loadLocal(){
    statusEl.classList.remove('hidden'); errorEl.classList.add('hidden'); errorEl.textContent='';
    try{
      const res=await fetch(LOCAL_XLSX_URL,{cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const ab=await res.arrayBuffer();
      const wb=XLSX.read(new Uint8Array(ab),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
      if(!rows.length) throw new Error('시트가 비어있습니다.');

      const headerKeys=Object.keys(rows[0]);
      const MAP={
        rank:pickColumn(headerKeys,MAP_CANDIDATES.rank),
        team:pickColumn(headerKeys,MAP_CANDIDATES.team),
        city:pickColumn(headerKeys,MAP_CANDIDATES.city),
        score:pickColumn(headerKeys,MAP_CANDIDATES.score),
        move:pickColumn(headerKeys,MAP_CANDIDATES.move),
        scoreChange:pickColumn(headerKeys,MAP_CANDIDATES.scoreChange)
      };

      const regionSet=new Set();
      BASE=rows.map((r,i)=>{
        const obj={
          rank:MAP.rank?Number(r[MAP.rank])||(i+1):(i+1),
          team:MAP.team?r[MAP.team]:'',
          city:MAP.city?r[MAP.city]:'',
          score:MAP.score?r[MAP.score]:'',
          move:MAP.move?(r[MAP.move]===''?0:r[MAP.move]):0,
          scoreChange:MAP.scoreChange?(r[MAP[ 'scoreChange' ]] || 0):null,
          raw:r
        };
        if(obj.city) regionSet.add(obj.city);
        return obj;
      });

      region.innerHTML='<option value="">전체 지역</option>'+
        Array.from(regionSet).sort().map(v=>`<option value="${v}">${v}</option>`).join('');

      statusEl.classList.add('hidden');
      FILTERED=[...BASE];
      buildLocalRankMap();
      renderScreen();
      buildExportRanges();

      search.addEventListener('input',applyFilter);
      region.addEventListener('change',applyFilter);
    }catch(err){
      statusEl.classList.add('hidden'); errorEl.classList.remove('hidden');
      errorEl.textContent=`데이터 로드 오류: ${err.message}. 파일이 같은 폴더에 있는지, 파일명이 정확한지 확인하세요.`;
    }
  }
  loadLocal();

  /* ========== 4:5 이미지 다운로드 (검색/필터/문구 제외, 15팀 범위 선택) ========== */
  document.getElementById('btnExport').addEventListener('click', async ()=>{
    // 선택된 범위 파싱
    const [s,e] = (exportRangeEl.value || '1-15').split('-').map(n=>parseInt(n,10));
    const startIdx = Math.max(0, (s||1)-1);
    const endIdx = Math.min(FILTERED.length, (e||15));
    const slice = FILTERED.slice(startIdx, endIdx);

    // 4:5 프레임
    const W = 1080, H = 1350;

    // 오프스크린 캡처 스테이지 생성(검색/필터/문구 제외)
    const stage = document.createElement('div');
    stage.id = 'exportStage';
    stage.className = 'exporting';
    stage.setAttribute('style', `width:${W}px; min-height:${H}px; max-width:${W}px; margin:0 auto; background:#0e141c; padding:24px;`);
    stage.innerHTML = `
      <div class="flex flex-col items-center w-full">
        <img src="BDR(배경없음).png" alt="BDR Logo" class="h-20 object-contain mb-2" crossOrigin="anonymous">
        <div class="flex items-end justify-between w-full">
          <h1 class="title text-3xl font-bold">BDR 랭킹 - 일반부</h1>
          <span class="text-lg font-semibold muted">${lastUpdated.textContent}</span>
        </div>
      </div>
      <div id="exportList" class="space-y-3 mt-4"></div>
    `;
    document.body.appendChild(stage);

    // 슬라이스 렌더링
    const exportList = stage.querySelector('#exportList');
    exportList.innerHTML = slice.map(cardHTML).join('');

    // 캡처
    try{
      const canvas = await html2canvas(stage, {
        backgroundColor: '#0e141c',
        useCORS: true,
        allowTaint: false,
        width: W,
        height: H,
        windowWidth: W,
        windowHeight: H,
        scale: 2
      });
      const link = document.createElement('a');
      const rangeLabel = `${s||1}-${e||15}`;
      link.download = `bdr_ranking_${rangeLabel}_${new Date().toISOString().slice(0,10)}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }catch(e){
      alert('이미지 저장 중 오류가 발생했습니다: ' + e.message);
    }finally{
      stage.remove();
    }
  });
</script>
</body>
</html>
